# PgsqlDataFlow

PgsqlDataFlow is a lightweight .NET 8 library designed to facilitate high-performance bulk data operations with PostgreSQL. It leverages the `Npgsql` library's binary `COPY` protocol for efficient bulk inserts and updates.

## Features

-   **High-Speed Bulk Inserts**: Uses PostgreSQL's `COPY FROM STDIN (FORMAT BINARY)` for maximum insert performance.
-   **Efficient Bulk Updates**: Performs bulk updates for specific columns using a temporary table and `COPY` command.
-   **Attribute-Based Mapping**: Maps C# model properties to database columns using `[Table]`, `[Column]`, and `[Key]` attributes from `System.ComponentModel.DataAnnotations.Schema`.
-   **Automatic Schema Validation**: Verifies that model property types match the database column types on initialization.
-   **Auto-increment Primary Key Support**: Automatically handles identity/serial columns during inserts.

## Requirements

- .NET 8
- PostgreSQL
- Npgsql (v9.0.2 or later)

## Installation

You can install PgsqlDataFlow via the NuGet Package Manager Console:

```powershell
Install-Package francisco-rma.PgsqlDataFlow
```

Or via the .NET CLI:

```bash
dotnet add package francisco-rma.PgsqlDataFlow
```

## Usage

### 1. Define your Model

Create a C# class that represents your database table. Use attributes from `System.ComponentModel.DataAnnotations.Schema` and `System.ComponentModel.DataAnnotations` to map your model to the table.

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

[Table("users")]
public class User
{
    [Key]
    [Column("id")]
    public int Id { get; set; }

    [Column("name")]
    public string Name { get; set; }

    [Column("email")]
    public string? Email { get; set; }

    [Column("created_at")]
    public DateTime CreatedAt { get; set; }
}
```

**Note:** The `id` column in the database should be an auto-incrementing primary key (e.g., `SERIAL` or `IDENTITY`).

### 2. Database Table

Ensure you have a corresponding table in your PostgreSQL database.

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email TEXT,
    created_at TIMESTAMP NOT NULL
);
```

### 3. Bulk Insert

Instantiate `BulkWriter<T>` with your connection string and call `CreateBulk` to insert data.

```csharp
using PgsqlDataFlow;

// Your PostgreSQL connection string
string connectionString = "Host=localhost;Username=user;Password=password;Database=mydb";

// Create a BulkWriter for the User model
var bulkWriter = new BulkWriter<User>(connectionString);

// Prepare a list of new users to insert
// The Id property is not set because it's auto-generated by the database.
var newUsers = new User[]
{
    new User { Name = "John Doe", Email = "john.doe@example.com", CreatedAt = DateTime.UtcNow },
    new User { Name = "Jane Smith", Email = "jane.smith@example.com", CreatedAt = DateTime.UtcNow }
};

// Perform the bulk insert operation
bulkWriter.CreateBulk(newUsers);

Console.WriteLine("Bulk insert completed successfully.");
```

### 4. Bulk Update a Column

To update a specific column for multiple rows, use the `UpdateColumnBulk` method. You need to provide the data, including the primary key for each row to be updated, and the index of the column to change.

```csharp
// Assume we have existing users with IDs 1 and 2 that we want to update.
var usersToUpdate = new User[]
{
    new User { Id = 1, Email = "john.d.updated@example.com" },
    new User { Id = 2, Email = "jane.s.updated@example.com" }
};

// Get the index of the column corresponding to the 'Email' property.
int emailColumnIndex = bulkWriter.GetColumnIndex(nameof(User.Email));

// Perform the bulk update on the 'email' column
bulkWriter.UpdateColumnBulk(usersToUpdate, emailColumnIndex);

Console.WriteLine("Bulk update completed successfully.");
```

## Contributing

Contributions are welcome! Please feel free to submit a pull request or open an issue for any bugs or feature requests.

## License

This project is licensed under the MIT License. See the `LICENSE` file for details. (Note: A LICENSE file should be added to the project).

